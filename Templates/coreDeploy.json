{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": ""
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": ""
    },
    "resourceLocation": {
      "type": "string",
      "allowedValues": [
        "East US",
        "East US 2",
        "West US",
        "Central US",
        "South Central US",
        "North Central US",
        "North Europe",
        "West Europe",
        "Southeast Asia",
        "East Asia",
        "Japan West",
        "Japan East",
        "Brazil South",
        "Australia East",
        "Australia Southeast"
      ],
      "metadata": {
        "description": "Azure region where all resources will be deployed. This is distinct from resource group location."
      }
    },
    "appName": {
      "type": "string",
      "metadata": {
        "description": "Application name used as a prefix for ARM resource"
      }
    },
    "vnetAddressRange": {
      "type": "string",
      "metadata": {
        "description": "The address range of the new VNET in CIDR format"
      }
    },
    "dcSubnetAddressRange": {
      "type": "string",
      "metadata": {
        "description": "The address range of the Domain Controller subnet in the new VNET"
      }
    },
    "feSubnetAddressRange": {
      "type": "string",
      "metadata": {
        "description": "The address range of the Front End subnet in the new VNET"
      }
    },
    "dbSubnetAddressRange": {
      "type": "string",
      "metadata": {
        "description": "The address range of the Database subnet in the new VNET"
      }
    },
    "domainAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the administrator of the new domain"
      }
    },
    "domainAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the administrator account of the new domain"
      }
    },
    "localAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name for the local machine administrator"
      }
    },
    "localAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the local machine administrator"
      }
    },
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "The FQDN of the AD Domain created "
      }
    },
    "diagSaType": {
      "type": "string",
      "metadata": {
        "description": "Diagnostics storage account type"
      },
      "defaultValue": "Standard_LRS"
    },
    "vmSaType": {
      "type": "string",
      "metadata": {
        "description": "Virtual machine storage account type"
      },
      "defaultValue": "Standard_LRS"
    },
    "pdcName": {
      "type": "string",
      "metadata": {
        "description": "The computer name of the Primary Domain Controller"
      },
      "defaultValue": "[concat(parameters('appName'),'-pdc')]"
    },
    "bdcName": {
      "type": "string",
      "metadata": {
        "description": "The computer name of Backup Domain Controller"
      },
      "defaultValue": "[concat(parameters('appName'),'-bdc')]"
    },
    "dcSku": {
      "type": "string",
      "metadata": {
        "description": "VM size of Domain Controllers."
      },
      "defaultValue": "Standard_A1"
    }
  },
  "variables": {
    // prefix nested deployments with parent deployment name
    // so all related deployments can be identified in Azure portals
    "storageDeploymentName": "[concat(deployment().name,'-storage')]",
    "vnetDeploymentName": "[concat(deployment().name,'-vnet')]",
    "jumpboxDeploymentName": "[concat(deployment().name,'-jumpbox')]",
    "domainDeploymentName": "[concat(deployment().name,'-domain')]"
  },
  "resources": [
    {
      "name": "[variables('storageDeploymentName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/storage/storage.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "resourceLocation": {
            "value": "[parameters('resourceLocation')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "vmSaType": {
            "value": "[parameters('vmSaType')]"
          },
          "diagSaType": {
            "value": "[parameters('diagSaType')]"
          }
        }
      }
    },
    {
      "name": "[variables('vnetDeploymentName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/vnet/vnet.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "resourceLocation": {
            "value": "[parameters('resourceLocation')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "vnetAddressRange": {
            "value": "[parameters('vnetAddressRange')]"
          },
          "dcSubnetAddressRange": {
            "value": "[parameters('dcSubnetAddressRange')]"
          },
          "feSubnetAddressRange": {
            "value": "[parameters('feSubnetAddressRange')]"
          },
          "dbSubnetAddressRange": {
            "value": "[parameters('dbSubnetAddressRange')]"
          }
        }
      }
    },
    {
      "name": "[variables('jumpboxDeploymentName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/jumpbox/jumpbox.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "resourceLocation": {
            "value": "[parameters('resourceLocation')]"
          },
          "localAdminUsername": {
            "value": "[parameters('localAdminUsername')]"
          },
          "localAdminPassword": {
            "value": "[parameters('localAdminPassword')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "vnetName": {
            "value": "[reference(variables('vnetDeploymentName')).outputs.vnetName.value]"
          },
          "subnetName": {
            "value": "[reference(variables('vnetDeploymentName')).outputs.dcSubnetName.value]"
          },
          "vmSaNames": {
            "value": "[reference(variables('storageDeploymentName')).outputs.vmStorageAccountNames.value]"
          },
          "diagSaName": {
            "value": "[reference(variables('storageDeploymentName')).outputs.diagStorageAccountName.value]"
          },
          "vnetResourceGroup": {
            "value": "[resourceGroup().name]"
          }
        }
      }
    },
    {
      "name": "[variables('domainDeploymentName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/domain/domain.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "resourceLocation": {
            "value": "[parameters('resourceLocation')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "domainAdminUsername": {
            "value": "[parameters('domainAdminUsername')]"
          },
          "domainAdminPassword": {
            "value": "[parameters('domainAdminPassword')]"
          },
          "pdcName": {
            "value": "[parameters('pdcName')]"
          },
          "bdcName": {
            "value": "[parameters('bdcName')]"
          },
          "appName": {
            "value": "[parameters('appName')]"
          },
          "dcSku": {
            "value": "[parameters('dcSku')]"
          },
          "vnetName": {
            "value": "[reference(variables('vnetDeploymentName')).outputs.vnetName.value]"
          },
          "subnetName": {
            "value": "[reference(variables('vnetDeploymentName')).outputs.dcSubnetName.value]"
          },
          "vmSaNames": {
            "value": "[reference(variables('storageDeploymentName')).outputs.vmStorageAccountNames.value]"
          },
          "diagSaName": {
            "value": "[reference(variables('storageDeploymentName')).outputs.diagStorageAccountName.value]"
          },
          "vnetResourceGroup": {
            "value": "[resourceGroup().name]"
          }
        }
      }
    }
  ],
  "outputs": {}
}